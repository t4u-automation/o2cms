name: E2E Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  # Allow manual trigger
  workflow_dispatch:

jobs:
  e2e-tests:
    name: Run E2E API Tests
    runs-on: ubuntu-latest
    environment: Production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required secrets
        run: |
          if [ -z "${{ secrets.O2_CMA_API_KEY }}" ]; then
            echo "❌ Error: O2_CMA_API_KEY secret is not set"
            echo ""
            echo "To fix this, go to your GitHub repository:"
            echo "  Settings → Secrets and variables → Actions → New repository secret"
            echo ""
            echo "Add the following secrets:"
            echo "  - O2_CMA_API_KEY (required)"
            echo "  - O2_CDA_TOKEN (optional, for CDA tests)"
            echo "  - O2_CPA_TOKEN (optional, for CPA tests)"
            exit 1
          fi
          echo "✓ Required secrets are configured"

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Run E2E Tests
        env:
          CMA_API_KEY: ${{ secrets.O2_CMA_API_KEY }}
          CDA_TOKEN: ${{ secrets.O2_CDA_TOKEN }}
          CPA_TOKEN: ${{ secrets.O2_CPA_TOKEN }}
        run: |
          cd api-tests
          chmod +x test-full-e2e.sh
          ./test-full-e2e.sh "$CMA_API_KEY" "$CDA_TOKEN" "$CPA_TOKEN" --ci

      - name: Upload test logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-logs
          path: api-tests/*.log
          retention-days: 7

